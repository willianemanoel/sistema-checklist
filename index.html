<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pendências por Categoria (Cloud)</title>
    <style>
        /* CSS BÁSICO para a nova interface de categorias */
        body { font-family: 'Arial', sans-serif; margin: 0; background-color: #2c3e50; color: #ecf0f1; }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #3498db; }

        /* Estilos do Formulário de Login */
        #login-screen { 
            max-width: 400px; 
            margin: 50px auto; 
            padding: 30px; 
            background-color: #34495e; 
            border-radius: 8px; 
            text-align: center;
        }
        #login-screen input[type="text"], #login-screen input[type="password"] {
            width: 90%;
            padding: 10px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #496a8a;
            color: #ecf0f1;
        }
        .btn { 
            background-color: #3498db; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        .btn:hover { background-color: #2980b9; }
        #login-message { color: #e74c3c; margin-top: 10px; }

        /* Estilos dos Cards de Clientes */
        #cliente-listagem { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .cliente-card { 
            background-color: #34495e; 
            padding: 20px; 
            border-radius: 8px; 
            width: 300px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
            border-left: 5px solid #3498db;
        }
        /* ... (CSS para Detalhe do Cliente, Categoria e Tabela de Documentos - MANTIDOS) */
        
        #detalhe-cliente { display: none; }
        .categoria-item { 
            background-color: #34495e; 
            padding: 15px; 
            border-radius: 5px; 
            margin-bottom: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background-color 0.3s;
        }
        .categoria-item:hover { background-color: #496a8a; }
        .categoria-pendente { border-left: 5px solid #e74c3c; }
        .categoria-recebido { border-left: 5px solid #2ecc71; }
        .categoria-info { flex-grow: 1; cursor: pointer; }
        
        .categoria-status { font-weight: bold; }
        .status-pendente { color: #e74c3c; }
        .status-recebido { color: #2ecc71; }
        
        .documentos-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            background-color: #496a8a;
            display: none; 
        }
        .documentos-table th, .documentos-table td { padding: 8px; border: 1px solid #34495e; text-align: left; font-size: 0.9em; }
        .doc-sim { color: #2ecc71; }
        .doc-nao { color: #e74c3c; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="titulo-principal">Controle de Pendências FTP</h1>

        <div id="login-screen">
            <h2>Acesso Restrito</h2>
            <p>Usuário de Teste: <code>auditoria</code> | Senha: <code>minhasenha123</code></p>
            <form id="login-form">
                <input type="text" id="username" placeholder="Usuário" required>
                <input type="password" id="password" placeholder="Senha" required>
                <button type="submit" class="btn">Entrar</button>
            </form>
            <p id="login-message"></p>
        </div>

        <div id="tela-clientes" style="display: none;">
            <button class="btn" onclick="logout()" style="float: right;">Sair</button>
            <p style="text-align: center;">Selecione um cliente para visualizar e controlar os documentos pendentes</p>
            <div id="cliente-listagem">
                <p id="loading-clientes">Carregando lista de clientes da API...</p>
            </div>
        </div>

        <div id="detalhe-cliente">
            <button class="btn" onclick="voltarParaClientes()">← Voltar</button>
            <h2 id="cliente-detalhe-nome" style="color: #2ecc71;"></h2>
            
            <h3>Categorias de Documentos</h3>
            <div id="lista-categorias">
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://sistema-checklist.onrender.com';
        let clienteAtualId = null;
        let clientesDataGlobal = [];
        let authToken = localStorage.getItem('authToken'); // Tenta buscar token do armazenamento local

        // ---------------------------------------------
        // FUNÇÕES DE SEGURANÇA E INICIALIZAÇÃO
        // ---------------------------------------------
        
        // Função utilitária para incluir o token no cabeçalho
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        function checkAuth() {
            if (authToken) {
                mostrarTela('tela-clientes');
                carregarClientes();
            } else {
                mostrarTela('login-screen');
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            checkAuth();
            document.getElementById('login-message').innerText = 'Você foi desconectado.';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageElement = document.getElementById('login-message');
            messageElement.innerText = 'Autenticando...';

            try {
                const response = await fetch(`${BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    messageElement.innerText = 'Login bem-sucedido!';
                    checkAuth(); // Vai para a tela de clientes
                } else {
                    messageElement.innerText = data.msg || 'Falha na autenticação. Verifique usuário/senha.';
                }
            } catch (error) {
                console.error('Erro de conexão ao tentar logar:', error);
                messageElement.innerText = 'Erro de rede. Tente novamente mais tarde.';
            }
        }
        
        // Listener para o formulário de login
        document.getElementById('login-form').addEventListener('submit', handleLogin);

        // ---------------------------------------------
        // FUNÇÕES DE NAVEGAÇÃO
        // ---------------------------------------------

        function mostrarTela(telaId) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('tela-clientes').style.display = 'none';
            document.getElementById('detalhe-cliente').style.display = 'none';
            document.getElementById(telaId).style.display = 'block';
        }

        function voltarParaClientes() {
            clienteAtualId = null;
            carregarClientes();
            mostrarTela('tela-clientes');
        }

        // ---------------------------------------------
        // ROTA 1: CARREGAR CLIENTES PARA A TELA INICIAL
        // ---------------------------------------------
        async function carregarClientes() {
            const loadingElement = document.getElementById('loading-clientes');
            if (loadingElement) {
                loadingElement.innerText = 'Carregando...';
            }
            
            try {
                // TOKEN ENVIADO AQUI
                const response = await fetch(`${BASE_URL}/api/clientes`, {
                    method: 'GET',
                    headers: getAuthHeaders() 
                });
                
                if (response.status === 401) {
                    // Se o token expirou ou é inválido, desloga
                    alert("Sessão expirada. Faça login novamente.");
                    logout();
                    return;
                }
                
                if (!response.ok) throw new Error('Falha ao carregar clientes');
                
                clientesDataGlobal = await response.json();
                renderizarClientes(clientesDataGlobal);

            } catch (error) {
                console.error('Erro ao buscar clientes:', error);
                const loadingElement = document.getElementById('loading-clientes');
                if (loadingElement) {
                    loadingElement.innerText = 'Erro ao carregar clientes da nuvem.';
                }
            }
        }

        function renderizarClientes(clientes) {
            const listagemDiv = document.getElementById('cliente-listagem');
            listagemDiv.innerHTML = ''; 

            clientes.forEach(cliente => {
                const card = document.createElement('div');
                card.className = 'cliente-card';
                card.onclick = () => carregarDetalhesCliente(cliente.id);

                const concluidoText = `Concluídas: ${cliente.concluidas}`;
                const pendentesText = `Pendentes: ${cliente.total_categorias - cliente.concluidas}`;

                card.innerHTML = `
                    <h2>${cliente.nome}</h2>
                    <p>ID: ${cliente.id} | Grupo: ${cliente.grupo}</p>
                    <p>Segmento: ${cliente.segmento}</p>
                    <p>Categorias: ${cliente.total_categorias} | <span class="concluido">${concluidoText}</span></p>
                    <p>${pendentesText}</p>
                `;
                listagemDiv.appendChild(card);
            });
            
            const loadingElement = document.getElementById('loading-clientes');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }

        // ---------------------------------------------
        // ROTA 2: CARREGAR DETALHES DAS CATEGORIAS
        // ---------------------------------------------
        async function carregarDetalhesCliente(clienteId) {
            clienteAtualId = clienteId;
            mostrarTela('detalhe-cliente');
            document.getElementById('cliente-detalhe-nome').innerText = 'Carregando detalhes...';
            document.getElementById('lista-categorias').innerHTML = ''; // Limpa a lista

            try {
                // TOKEN ENVIADO AQUI
                const response = await fetch(`${BASE_URL}/api/clientes/${clienteId}/categorias`, {
                    method: 'GET',
                    headers: getAuthHeaders() 
                });
                
                if (response.status === 401) {
                    alert("Sessão expirada. Faça login novamente.");
                    logout();
                    return;
                }

                if (!response.ok) throw new Error('Falha ao carregar detalhes do cliente');
                
                const data = await response.json();
                
                document.getElementById('cliente-detalhe-nome').innerText = data.cliente_nome;
                renderizarCategorias(data.categorias);

            } catch (error) {
                console.error('Erro ao buscar categorias:', error);
                document.getElementById('lista-categorias').innerHTML = '<p style="color: red;">Erro ao carregar categorias da API.</p>';
            }
        }
        
        // ... (renderizarCategorias MANTIDA) ...
        function renderizarCategorias(categorias) {
            const listaDiv = document.getElementById('lista-categorias');
            listaDiv.innerHTML = '';
            
            categorias.forEach(categoria => {
                const isRecebido = categoria.status_recebimento === 'RECEBIDO';
                const totalDocs = categoria.total_documentos;
                const docsEncontrados = categoria.documentos_encontrados;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `categoria-item ${isRecebido ? 'categoria-recebido' : 'categoria-pendente'}`;

                // Conteúdo Principal
                itemDiv.innerHTML = `
                    <div class="categoria-info" data-categoria-nome="${categoria.nome_categoria}" onclick="toggleDocumentos(this)">
                        <strong>${categoria.nome_categoria}</strong>
                        <p style="margin: 3px 0; font-size: 0.8em;">
                            Documentos: ${totalDocs} | Encontrados: ${docsEncontrados}
                        </p>
                        <p class="categoria-status ${isRecebido ? 'status-recebido' : 'status-pendente'}">
                            Status: ${categoria.status_recebimento}
                        </p>
                    </div>
                    <div>
                        <button class="btn" onclick="marcarCategoria(event, '${categoria.nome_categoria}', ${isRecebido ? 'false' : 'true'})">
                            ${isRecebido ? 'Reverter para PENDENTE' : 'Marcar como RECEBIDO'}
                        </button>
                    </div>
                `;
                
                // Tabela de Documentos Oculta
                const table = document.createElement('table');
                table.className = 'documentos-table';
                table.id = `table-${categoria.nome_categoria.replace(/\s/g, '-')}`; 
                table.innerHTML = `
                    <thead><tr><th>Documento Cobrado</th><th>Status no Bucket</th></tr></thead>
                    <tbody>${categoria.detalhes_documentos.map(doc => `
                        <tr>
                            <td>${doc.nome_documento}</td>
                            <td class="${doc.status_bucket === 'Sim' ? 'doc-sim' : 'doc-nao'}">${doc.status_bucket}</td>
                        </tr>
                    `).join('')}</tbody>
                `;
                
                listaDiv.appendChild(itemDiv);
                listaDiv.appendChild(table);
            });
        }
        
        // ---------------------------------------------
        // FUNÇÕES DE INTERAÇÃO
        // ---------------------------------------------
        
        function toggleDocumentos(element) {
            const nomeCategoria = element.dataset.categoriaNome;
            const tableId = `table-${nomeCategoria.replace(/\s/g, '-')}`;
            const table = document.getElementById(tableId);
            
            if (table.style.display === 'block') {
                table.style.display = 'none';
            } else {
                document.querySelectorAll('.documentos-table').forEach(t => t.style.display = 'none');
                table.style.display = 'block';
            }
        }

        async function marcarCategoria(event, nomeCategoria, marcarComoRecebido) {
            event.stopPropagation(); 

            const novoStatus = marcarComoRecebido ? 'RECEBIDO' : 'PENDENTE';
            
            const payload = {
                cliente_id: clienteAtualId,
                nome_categoria: nomeCategoria,
                status: novoStatus
            };

            try {
                // TOKEN ENVIADO AQUI
                const response = await fetch(`${BASE_URL}/api/categorias/confirmar`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });
                
                if (response.status === 401) {
                    alert("Sessão expirada. Faça login novamente.");
                    logout();
                    return;
                }
                
                const resultado = await response.json();
                
                if (response.ok) {
                    alert(`Sucesso! Categoria '${nomeCategoria}' marcada como ${novoStatus}.`);
                    carregarDetalhesCliente(clienteAtualId); 
                } else {
                    alert(`Erro ao salvar: ${resultado.erro || 'Erro desconhecido.'}`);
                }
                
            } catch (error) {
                console.error('Erro de conexão ao tentar salvar:', error);
                alert('Erro de conexão ao tentar salvar o status na nuvem.');
            }
        }

        // INICIA O FLUXO: verifica se o usuário já está logado
        window.onload = checkAuth;
    </script>
</body>
</html>